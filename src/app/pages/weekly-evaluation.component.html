<div class="space-y-6">
  <mat-card class="overflow-hidden border bg-gradient-to-br from-primary/5 via-background to-background shadow-sm">
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <div>
        <h2 class="text-2xl font-semibold tracking-tight text-foreground">Weekly Evaluation</h2>
        <p class="text-sm text-muted-foreground">Review performance signals, capture strengths, and coach the week ahead.</p>
      </div>
      <button mat-stroked-button color="primary" type="button" (click)="refreshData()">
        <mat-icon>refresh</mat-icon>
        Refresh data
      </button>
    </div>
    <div class="mt-4 flex flex-wrap items-center gap-2">
      <mat-chip color="primary" selected class="bg-primary/10 text-primary">
        <mat-icon matChipAvatar>people</mat-icon>
        {{ rows().length }} total records
      </mat-chip>
      <mat-chip class="bg-emerald-500/10 text-emerald-600">
        <mat-icon matChipAvatar>badge</mat-icon>
        {{ employees().length }} employees
      </mat-chip>
      <mat-chip class="bg-sky-500/10 text-sky-600">
        <mat-icon matChipAvatar>school</mat-icon>
        {{ trainees().length }} trainees
      </mat-chip>
    </div>
  </mat-card>

  <mat-card *ngIf="loading()" class="flex items-center justify-between gap-4 border bg-card/90 p-6">
    <div>
      <h3 class="text-base font-semibold text-foreground">Fetching personnel roster…</h3>
      <p class="text-sm text-muted-foreground">Hang tight while we sync the latest headcount and trainee updates.</p>
    </div>
    <mat-progress-bar mode="indeterminate" color="primary" class="w-40"></mat-progress-bar>
  </mat-card>

  <div *ngIf="!loading()" class="space-y-6">
    <mat-card class="flex flex-wrap items-center justify-between gap-3 border bg-card/95 px-4 py-3 text-sm text-muted-foreground">
      <span class="font-medium text-foreground">Snapshot: {{ rows().length }} records ready for review</span>
      <div class="flex items-center gap-4">
        <span class="inline-flex items-center gap-1"><mat-icon class="!text-base text-emerald-500">circle</mat-icon> Employees {{ employees().length }}</span>
        <span class="inline-flex items-center gap-1"><mat-icon class="!text-base text-sky-500">circle</mat-icon> Trainees {{ trainees().length }}</span>
      </div>
    </mat-card>

    <div class="grid gap-6 xl:grid-cols-2">
      <mat-card class="flex h-full flex-col rounded-2xl border bg-card/95 shadow-sm transition-shadow duration-200 hover:shadow-lg">
        <div class="flex items-center justify-between px-6 py-4">
          <div>
            <h3 class="text-lg font-semibold text-foreground">Employees</h3>
            <p class="text-sm text-muted-foreground">Evaluate coaching momentum for each department.</p>
          </div>
          <mat-chip class="bg-primary/10 text-primary" matBadge="" matBadgeOverlap="false" matBadgeColor="primary">
            {{ filteredEmployeeRows().length }} ready
          </mat-chip>
        </div>
        <mat-divider></mat-divider>
        <div class="flex flex-col gap-3 px-6 py-4 md:flex-row md:items-center">
          <mat-form-field appearance="outline" class="w-full md:max-w-xs">
            <mat-icon matPrefix>search</mat-icon>
            <input
              matInput
              type="text"
              placeholder="Filter employees…"
              (input)="onEmployeeFilterChange($any($event.target).value)"
            />
          </mat-form-field>
          <span class="text-xs text-muted-foreground">{{ filteredEmployeeRows().length }} match{{ filteredEmployeeRows().length === 1 ? '' : 'es' }} · {{ itemsPerPage }} per page</span>
        </div>
        <div class="flex-1 px-6 pb-6">
          <ng-container *ngIf="filteredEmployeeRows().length; else noEmployees">
            <div class="rounded-xl border bg-background/80 shadow-inner">
              <div class="max-h-[520px] overflow-auto">
                <table class="min-w-full divide-y divide-border text-sm">
                  <thead class="bg-muted/30 text-muted-foreground">
                    <tr>
                      <th scope="col" class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide">Member</th>
                      <th scope="col" class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide">Department</th>
                      <th scope="col" class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide">Status</th>
                      <th scope="col" class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wide">Actions</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-border">
                    <ng-container *ngFor="let group of paginatedEmployeeGroups(); trackBy: trackDepartment">
                      <tr
                        class="cursor-pointer bg-muted/40 text-[0.7rem] font-semibold uppercase tracking-wide text-muted-foreground transition hover:bg-muted/60"
                        (click)="toggleDepartment('employee', group.department)"
                        [attr.aria-expanded]="isDepartmentExpanded('employee', group.department)"
                      >
                        <td colspan="4" class="px-4 py-2">
                          <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                              <mat-icon class="transition" [style.transform]="isDepartmentExpanded('employee', group.department) ? 'rotate(180deg)' : 'rotate(0deg)'">expand_more</mat-icon>
                              <span>{{ group.department || 'Unassigned' }}</span>
                            </div>
                            <span class="rounded-full bg-primary/10 px-2 py-0.5 text-[0.65rem] font-semibold text-primary">
                              {{ group.members.length }} member{{ group.members.length === 1 ? '' : 's' }}
                            </span>
                          </div>
                        </td>
                      </tr>
                      <ng-container *ngIf="isDepartmentExpanded('employee', group.department)">
                        <tr
                          *ngFor="let row of group.members; trackBy: trackRow"
                          class="transition hover:bg-muted/20"
                          (mouseenter)="setHoveredRow(row.id)"
                          (mouseleave)="setHoveredRow(null)"
                        >
                          <td class="px-4 py-3">
                            <div class="flex items-center gap-3">
                              <img
                                [src]="row.avatar || 'https://ui-avatars.com/api/?name=' + row.name"
                                [alt]="row.name"
                                class="size-9 rounded-full object-cover shadow-sm"
                              />
                              <div>
                                <p class="font-medium text-foreground">{{ row.name }}</p>
                                <p class="text-xs text-muted-foreground">{{ row.position }}</p>
                              </div>
                            </div>
                          </td>
                          <td class="px-4 py-3 text-sm text-muted-foreground">{{ row.department }}</td>
                          <td class="px-4 py-3">
                            <span class="rounded-full px-2 py-0.5 text-xs" [ngClass]="getStatusBadgeClass(row.status)">
                              {{ row.status || '--' }}
                            </span>
                          </td>
                          <td class="px-4 py-3 text-right">
                            <button
                              mat-stroked-button
                              color="primary"
                              type="button"
                              class="!text-xs"
                              (click)="openEvaluationModal(row.raw, 'employee')"
                            >
                              <mat-icon class="!text-base">add_task</mat-icon>
                              Evaluate
                            </button>
                          </td>
                        </tr>
                      </ng-container>
                    </ng-container>
                  </tbody>
                </table>
              </div>
            </div>
          </ng-container>
          <ng-template #noEmployees>
            <div class="flex flex-col items-center justify-center gap-3 py-12 text-center">
              <mat-icon class="text-4xl text-muted-foreground">groups_2</mat-icon>
              <p class="text-sm text-muted-foreground">No employees found for this filter.</p>
            </div>
          </ng-template>
        </div>
        <div *ngIf="filteredEmployeeRows().length > itemsPerPage" class="border-t px-6 py-4">
          <app-paginator
            [totalItems]="filteredEmployeeRows().length"
            [itemsPerPage]="itemsPerPage"
            [currentPage]="employeeCurrentPage()"
            (pageChange)="onEmployeePageChange($event)"
          ></app-paginator>
        </div>
      </mat-card>

      <mat-card class="flex h-full flex-col rounded-2xl border bg-card/95 shadow-sm transition-shadow duration-200 hover:shadow-lg">
        <div class="flex items-center justify-between px-6 py-4">
          <div>
            <h3 class="text-lg font-semibold text-foreground">Trainees</h3>
            <p class="text-sm text-muted-foreground">Spot growth opportunities and coaching needs.</p>
          </div>
          <mat-chip class="bg-primary/10 text-primary">
            {{ filteredTraineeRows().length }} ready
          </mat-chip>
        </div>
        <mat-divider></mat-divider>
        <div class="flex flex-col gap-3 px-6 py-4 md:flex-row md:items-center">
          <mat-form-field appearance="outline" class="w-full md:max-w-xs">
            <mat-icon matPrefix>manage_search</mat-icon>
            <input
              matInput
              type="text"
              placeholder="Filter trainees…"
              (input)="onTraineeFilterChange($any($event.target).value)"
            />
          </mat-form-field>
          <span class="text-xs text-muted-foreground">{{ filteredTraineeRows().length }} match{{ filteredTraineeRows().length === 1 ? '' : 'es' }} · {{ itemsPerPage }} per page</span>
        </div>
        <div class="flex-1 px-6 pb-6">
          <ng-container *ngIf="filteredTraineeRows().length; else noTrainees">
            <div class="rounded-xl border bg-background/80 shadow-inner">
              <div class="max-h-[520px] overflow-auto">
                <table class="min-w-full divide-y divide-border text-sm">
                  <thead class="bg-muted/30 text-muted-foreground">
                    <tr>
                      <th scope="col" class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide">Trainee</th>
                      <th scope="col" class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide">Department</th>
                      <th scope="col" class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide">Status</th>
                      <th scope="col" class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wide">Actions</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-border">
                    <ng-container *ngFor="let group of paginatedTraineeGroups(); trackBy: trackDepartment">
                      <tr
                        class="cursor-pointer bg-muted/40 text-[0.7rem] font-semibold uppercase tracking-wide text-muted-foreground transition hover:bg-muted/60"
                        (click)="toggleDepartment('trainee', group.department)"
                        [attr.aria-expanded]="isDepartmentExpanded('trainee', group.department)"
                      >
                        <td colspan="4" class="px-4 py-2">
                          <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                              <mat-icon class="transition" [style.transform]="isDepartmentExpanded('trainee', group.department) ? 'rotate(180deg)' : 'rotate(0deg)'">expand_more</mat-icon>
                              <span>{{ group.department || 'Unassigned' }}</span>
                            </div>
                            <span class="rounded-full bg-primary/10 px-2 py-0.5 text-[0.65rem] font-semibold text-primary">
                              {{ group.members.length }} trainee{{ group.members.length === 1 ? '' : 's' }}
                            </span>
                          </div>
                        </td>
                      </tr>
                      <ng-container *ngIf="isDepartmentExpanded('trainee', group.department)">
                        <tr
                          *ngFor="let row of group.members; trackBy: trackRow"
                          class="transition hover:bg-muted/20"
                          (mouseenter)="setHoveredRow(row.id)"
                          (mouseleave)="setHoveredRow(null)"
                        >
                          <td class="px-4 py-3">
                            <div class="flex items-center gap-3">
                              <img
                                [src]="row.avatar || 'https://ui-avatars.com/api/?name=' + row.name"
                                [alt]="row.name"
                                class="size-9 rounded-full object-cover shadow-sm"
                              />
                              <div>
                                <p class="font-medium text-foreground">{{ row.name }}</p>
                                <p class="text-xs text-muted-foreground">{{ row.position }}</p>
                              </div>
                            </div>
                          </td>
                          <td class="px-4 py-3 text-sm text-muted-foreground">{{ row.department }}</td>
                          <td class="px-4 py-3">
                            <span class="rounded-full px-2 py-0.5 text-xs" [ngClass]="getStatusBadgeClass(row.status)">
                              {{ row.status || '--' }}
                            </span>
                          </td>
                          <td class="px-4 py-3 text-right">
                            <button
                              mat-stroked-button
                              color="primary"
                              type="button"
                              class="!text-xs"
                              (click)="openEvaluationModal(row.raw, 'trainee')"
                            >
                              <mat-icon class="!text-base">playlist_add_check</mat-icon>
                              Evaluate
                            </button>
                          </td>
                        </tr>
                      </ng-container>
                    </ng-container>
                  </tbody>
                </table>
              </div>
            </div>
          </ng-container>
          <ng-template #noTrainees>
            <div class="flex flex-col items-center justify-center gap-3 py-12 text-center">
              <mat-icon class="text-4xl text-muted-foreground">sentiment_neutral</mat-icon>
              <p class="text-sm text-muted-foreground">No trainees match the current filters.</p>
            </div>
          </ng-template>
        </div>
        <div *ngIf="filteredTraineeRows().length > itemsPerPage" class="border-t px-6 py-4">
          <app-paginator
            [totalItems]="filteredTraineeRows().length"
            [itemsPerPage]="itemsPerPage"
            [currentPage]="traineeCurrentPage()"
            (pageChange)="onTraineePageChange($event)"
          ></app-paginator>
        </div>
      </mat-card>
    </div>
  </div>
</div>

<div
  *ngIf="showModal()"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 animate-fade-in"
  (click)="closeModal()"
  style="backdrop-filter: blur(4px);"
>
  <mat-card
    class="max-h-[90vh] w-full max-w-2xl overflow-y-auto rounded-2xl border bg-background shadow-xl animate-scale-in"
    (click)="$event.stopPropagation()"
  >
    <div class="sticky top-0 z-10 flex items-center justify-between border-b bg-background/95 px-6 py-4 backdrop-blur">
      <div>
        <h3 class="text-lg font-semibold text-foreground">Weekly Evaluation</h3>
        <p class="text-sm text-muted-foreground">{{ getFullName(selectedPerson()) }} · {{ personType() === 'employee' ? 'Employee' : 'Trainee' }}</p>
      </div>
      <button mat-icon-button (click)="closeModal()" aria-label="Close">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <form [formGroup]="evaluationForm" (ngSubmit)="submitEvaluation()" class="space-y-6 p-6">
      <div class="grid gap-x-8 gap-y-6 sm:grid-cols-2">
        <div class="space-y-3">
          <label class="text-sm font-medium text-foreground">Performance</label>
          <app-star-rating formControlName="performance"></app-star-rating>
        </div>
        <div class="space-y-3">
          <label class="text-sm font-medium text-foreground">Productivity</label>
          <app-star-rating formControlName="productivity"></app-star-rating>
        </div>
        <div class="space-y-3">
          <label class="text-sm font-medium text-foreground">Teamwork</label>
          <app-star-rating formControlName="teamwork"></app-star-rating>
        </div>
        <div class="space-y-3">
          <label class="text-sm font-medium text-foreground">Initiative</label>
          <app-star-rating formControlName="initiative"></app-star-rating>
        </div>
      </div>

      <mat-card class="border bg-primary/5 p-4">
        <div class="flex items-center justify-between">
          <span class="text-sm font-medium text-foreground">Overall Average</span>
          <span class="text-2xl font-bold text-primary">{{ getAverageRating().toFixed(1) }}/5</span>
        </div>
        <mat-progress-bar
          mode="determinate"
          color="primary"
          class="mt-3 rounded-full bg-primary/20"
          [value]="(getAverageRating() / 5) * 100"
        ></mat-progress-bar>
      </mat-card>

      <div class="space-y-2">
        <label class="text-sm font-medium text-foreground">Comments <span class="text-destructive">*</span></label>
        <textarea
          formControlName="comments"
          rows="4"
          placeholder="Provide overall feedback on this week's performance..."
          class="w-full rounded-lg border border-input bg-background px-3 py-2 text-sm text-foreground outline-none ring-primary/20 transition focus:ring-2"
        ></textarea>
        <p *ngIf="evaluationForm.get('comments')?.invalid && evaluationForm.get('comments')?.touched" class="text-xs text-destructive">
          Comments are required
        </p>
      </div>

      <div class="space-y-2">
        <label class="text-sm font-medium text-foreground">Strengths</label>
        <textarea
          formControlName="strengths"
          rows="3"
          placeholder="What did they do particularly well this week?"
          class="w-full rounded-lg border border-input bg-background px-3 py-2 text-sm text-foreground outline-none ring-primary/20 transition focus:ring-2"
        ></textarea>
      </div>

      <div class="space-y-2">
        <label class="text-sm font-medium text-foreground">Areas for Improvement</label>
        <textarea
          formControlName="improvements"
          rows="3"
          placeholder="Where can we help them grow faster?"
          class="w-full rounded-lg border border-input bg-background px-3 py-2 text-sm text-foreground outline-none ring-primary/20 transition focus:ring-2"
        ></textarea>
      </div>

      <div class="flex flex-col gap-3 sm:flex-row">
        <button
          mat-flat-button
          color="primary"
          type="submit"
          class="flex-1"
          [disabled]="evaluationForm.invalid"
        >
          Submit evaluation
        </button>
        <button mat-stroked-button color="primary" type="button" (click)="closeModal()">
          Cancel
        </button>
      </div>
    </form>
  </mat-card>
</div>
