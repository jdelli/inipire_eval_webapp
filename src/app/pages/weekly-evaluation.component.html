<div class="space-y-6">
  <mat-card class="overflow-hidden border bg-gradient-to-br from-primary/5 via-background to-background shadow-sm">
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <div>
        <h2 class="text-2xl font-semibold tracking-tight text-foreground">Weekly Evaluation</h2>
        <p class="text-sm text-muted-foreground">Review performance signals, capture strengths, and coach the week ahead.</p>
      </div>
      <button mat-stroked-button color="primary" type="button" (click)="refreshData()">
        <mat-icon>refresh</mat-icon>
        Refresh data
      </button>
    </div>
    <div class="mt-4 flex flex-wrap items-center gap-2">
      <mat-chip color="primary" selected class="bg-primary/10 text-primary">
        <mat-icon matChipAvatar>people</mat-icon>
        {{ rows().length }} total records
      </mat-chip>
      <mat-chip class="bg-emerald-500/10 text-emerald-600">
        <mat-icon matChipAvatar>badge</mat-icon>
        {{ employees().length }} employees
      </mat-chip>
      <mat-chip class="bg-sky-500/10 text-sky-600">
        <mat-icon matChipAvatar>school</mat-icon>
        {{ trainees().length }} trainees
      </mat-chip>
    </div>
  </mat-card>

  <mat-card *ngIf="loading()" class="flex items-center justify-between gap-4 border bg-card/90 p-6">
    <div>
      <h3 class="text-base font-semibold text-foreground">Fetching personnel roster…</h3>
      <p class="text-sm text-muted-foreground">Hang tight while we sync the latest headcount and trainee updates.</p>
    </div>
    <mat-progress-bar mode="indeterminate" color="primary" class="w-40"></mat-progress-bar>
  </mat-card>

  <div *ngIf="!loading()" class="space-y-6">
    <mat-card class="flex flex-wrap items-center justify-between gap-3 border bg-card/95 px-4 py-3 text-sm text-muted-foreground">
      <span class="font-medium text-foreground">Snapshot: {{ rows().length }} records ready for review</span>
      <div class="flex items-center gap-4">
        <span class="inline-flex items-center gap-1"><mat-icon class="!text-base text-emerald-500">circle</mat-icon> Employees {{ employees().length }}</span>
        <span class="inline-flex items-center gap-1"><mat-icon class="!text-base text-sky-500">circle</mat-icon> Trainees {{ trainees().length }}</span>
      </div>
    </mat-card>

    <div class="grid gap-6 xl:grid-cols-2">
      <mat-card class="flex h-full flex-col rounded-2xl border bg-card/95 shadow-sm transition-shadow duration-200 hover:shadow-lg">
        <div class="flex items-center justify-between px-6 py-4">
          <div>
            <h3 class="text-lg font-semibold text-foreground">Employees</h3>
            <p class="text-sm text-muted-foreground">Evaluate coaching momentum for each department.</p>
          </div>
          <mat-chip class="bg-primary/10 text-primary" matBadge="" matBadgeOverlap="false" matBadgeColor="primary">
            {{ filteredEmployeeRows().length }} ready
          </mat-chip>
        </div>
        <mat-divider></mat-divider>
        <div class="flex flex-col gap-3 px-6 py-4 md:flex-row md:items-center">
          <mat-form-field appearance="outline" class="w-full md:max-w-xs">
            <mat-icon matPrefix>search</mat-icon>
            <input
              matInput
              type="text"
              placeholder="Filter employees…"
              (input)="onEmployeeFilterChange($any($event.target).value)"
            />
          </mat-form-field>
          <span class="text-xs text-muted-foreground">{{ filteredEmployeeRows().length }} match{{ filteredEmployeeRows().length === 1 ? '' : 'es' }} · {{ itemsPerPage }} per page</span>
        </div>
        <div class="flex-1 px-6 pb-6">
          <ng-container *ngIf="filteredEmployeeRows().length; else noEmployees">
            <div class="rounded-xl border bg-background/80 shadow-inner">
              <div class="max-h-[520px] overflow-auto">
                <table class="min-w-full divide-y divide-border text-sm">
                  <thead class="bg-muted/30 text-muted-foreground">
                    <tr>
                      <th scope="col" class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide">Member</th>
                      <th scope="col" class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide">Department</th>
                      <th scope="col" class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide">Status</th>
                      <th scope="col" class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wide">Actions</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-border">
                    <ng-container *ngFor="let group of paginatedEmployeeGroups(); trackBy: trackDepartment">
                      <tr
                        class="cursor-pointer bg-muted/40 text-[0.7rem] font-semibold uppercase tracking-wide text-muted-foreground transition hover:bg-muted/60"
                        (click)="toggleDepartment('employee', group.department)"
                        [attr.aria-expanded]="isDepartmentExpanded('employee', group.department)"
                      >
                        <td colspan="4" class="px-4 py-2">
                          <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                              <mat-icon class="transition" [style.transform]="isDepartmentExpanded('employee', group.department) ? 'rotate(180deg)' : 'rotate(0deg)'">expand_more</mat-icon>
                              <span>{{ group.department || 'Unassigned' }}</span>
                            </div>
                            <span class="rounded-full bg-primary/10 px-2 py-0.5 text-[0.65rem] font-semibold text-primary">
                              {{ group.members.length }} member{{ group.members.length === 1 ? '' : 's' }}
                            </span>
                          </div>
                        </td>
                      </tr>
                      <ng-container *ngIf="isDepartmentExpanded('employee', group.department)">
                        <tr
                          *ngFor="let row of group.members; trackBy: trackRow"
                          class="transition hover:bg-muted/20"
                          (mouseenter)="setHoveredRow(row.id)"
                          (mouseleave)="setHoveredRow(null)"
                        >
                          <td class="px-4 py-3">
                            <div class="flex items-center gap-3">
                              <img
                                [src]="row.avatar || 'https://ui-avatars.com/api/?name=' + row.name"
                                [alt]="row.name"
                                class="size-9 rounded-full object-cover shadow-sm"
                              />
                              <div>
                                <p class="font-medium text-foreground">{{ row.name }}</p>
                                <p class="text-xs text-muted-foreground">{{ row.position }}</p>
                              </div>
                            </div>
                          </td>
                          <td class="px-4 py-3 text-sm text-muted-foreground">{{ row.department }}</td>
                          <td class="px-4 py-3">
                            <span class="rounded-full px-2 py-0.5 text-xs" [ngClass]="getStatusBadgeClass(row.status)">
                              {{ row.status || '--' }}
                            </span>
                          </td>
                          <td class="px-4 py-3 text-right">
                            <button
                              mat-stroked-button
                              color="primary"
                              type="button"
                              class="!text-xs"
                              (click)="openEvaluationModal(row.raw, 'employee')"
                            >
                              <mat-icon class="!text-base">add_task</mat-icon>
                              Evaluate
                            </button>
                          </td>
                        </tr>
                      </ng-container>
                    </ng-container>
                  </tbody>
                </table>
              </div>
            </div>
          </ng-container>
          <ng-template #noEmployees>
            <div class="flex flex-col items-center justify-center gap-3 py-12 text-center">
              <mat-icon class="text-4xl text-muted-foreground">groups_2</mat-icon>
              <p class="text-sm text-muted-foreground">No employees found for this filter.</p>
            </div>
          </ng-template>
        </div>
        <div *ngIf="filteredEmployeeRows().length > itemsPerPage" class="border-t px-6 py-4">
          <app-paginator
            [totalItems]="filteredEmployeeRows().length"
            [itemsPerPage]="itemsPerPage"
            [currentPage]="employeeCurrentPage()"
            (pageChange)="onEmployeePageChange($event)"
          ></app-paginator>
        </div>
      </mat-card>

      <mat-card class="flex h-full flex-col rounded-2xl border bg-card/95 shadow-sm transition-shadow duration-200 hover:shadow-lg">
        <div class="flex items-center justify-between px-6 py-4">
          <div>
            <h3 class="text-lg font-semibold text-foreground">Trainees</h3>
            <p class="text-sm text-muted-foreground">Spot growth opportunities and coaching needs.</p>
          </div>
          <mat-chip class="bg-primary/10 text-primary">
            {{ filteredTraineeRows().length }} ready
          </mat-chip>
        </div>
        <mat-divider></mat-divider>
        <div class="flex flex-col gap-3 px-6 py-4 md:flex-row md:items-center">
          <mat-form-field appearance="outline" class="w-full md:max-w-xs">
            <mat-icon matPrefix>manage_search</mat-icon>
            <input
              matInput
              type="text"
              placeholder="Filter trainees…"
              (input)="onTraineeFilterChange($any($event.target).value)"
            />
          </mat-form-field>
          <span class="text-xs text-muted-foreground">{{ filteredTraineeRows().length }} match{{ filteredTraineeRows().length === 1 ? '' : 'es' }} · {{ itemsPerPage }} per page</span>
        </div>
        <div class="flex-1 px-6 pb-6">
          <ng-container *ngIf="filteredTraineeRows().length; else noTrainees">
            <div class="rounded-xl border bg-background/80 shadow-inner">
              <div class="max-h-[520px] overflow-auto">
                <table class="min-w-full divide-y divide-border text-sm">
                  <thead class="bg-muted/30 text-muted-foreground">
                    <tr>
                      <th scope="col" class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide">Trainee</th>
                      <th scope="col" class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide">Department</th>
                      <th scope="col" class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide">Status</th>
                      <th scope="col" class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wide">Actions</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-border">
                    <ng-container *ngFor="let group of paginatedTraineeGroups(); trackBy: trackDepartment">
                      <tr
                        class="cursor-pointer bg-muted/40 text-[0.7rem] font-semibold uppercase tracking-wide text-muted-foreground transition hover:bg-muted/60"
                        (click)="toggleDepartment('trainee', group.department)"
                        [attr.aria-expanded]="isDepartmentExpanded('trainee', group.department)"
                      >
                        <td colspan="4" class="px-4 py-2">
                          <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                              <mat-icon class="transition" [style.transform]="isDepartmentExpanded('trainee', group.department) ? 'rotate(180deg)' : 'rotate(0deg)'">expand_more</mat-icon>
                              <span>{{ group.department || 'Unassigned' }}</span>
                            </div>
                            <span class="rounded-full bg-primary/10 px-2 py-0.5 text-[0.65rem] font-semibold text-primary">
                              {{ group.members.length }} trainee{{ group.members.length === 1 ? '' : 's' }}
                            </span>
                          </div>
                        </td>
                      </tr>
                      <ng-container *ngIf="isDepartmentExpanded('trainee', group.department)">
                        <tr
                          *ngFor="let row of group.members; trackBy: trackRow"
                          class="transition hover:bg-muted/20"
                          (mouseenter)="setHoveredRow(row.id)"
                          (mouseleave)="setHoveredRow(null)"
                        >
                          <td class="px-4 py-3">
                            <div class="flex items-center gap-3">
                              <img
                                [src]="row.avatar || 'https://ui-avatars.com/api/?name=' + row.name"
                                [alt]="row.name"
                                class="size-9 rounded-full object-cover shadow-sm"
                              />
                              <div>
                                <p class="font-medium text-foreground">{{ row.name }}</p>
                                <p class="text-xs text-muted-foreground">{{ row.position }}</p>
                              </div>
                            </div>
                          </td>
                          <td class="px-4 py-3 text-sm text-muted-foreground">{{ row.department }}</td>
                          <td class="px-4 py-3">
                            <span class="rounded-full px-2 py-0.5 text-xs" [ngClass]="getStatusBadgeClass(row.status)">
                              {{ row.status || '--' }}
                            </span>
                          </td>
                          <td class="px-4 py-3 text-right">
                            <button
                              mat-stroked-button
                              color="primary"
                              type="button"
                              class="!text-xs"
                              (click)="openEvaluationModal(row.raw, 'trainee')"
                            >
                              <mat-icon class="!text-base">playlist_add_check</mat-icon>
                              Evaluate
                            </button>
                          </td>
                        </tr>
                      </ng-container>
                    </ng-container>
                  </tbody>
                </table>
              </div>
            </div>
          </ng-container>
          <ng-template #noTrainees>
            <div class="flex flex-col items-center justify-center gap-3 py-12 text-center">
              <mat-icon class="text-4xl text-muted-foreground">sentiment_neutral</mat-icon>
              <p class="text-sm text-muted-foreground">No trainees match the current filters.</p>
            </div>
          </ng-template>
        </div>
        <div *ngIf="filteredTraineeRows().length > itemsPerPage" class="border-t px-6 py-4">
          <app-paginator
            [totalItems]="filteredTraineeRows().length"
            [itemsPerPage]="itemsPerPage"
            [currentPage]="traineeCurrentPage()"
            (pageChange)="onTraineePageChange($event)"
          ></app-paginator>
        </div>
      </mat-card>
    </div>
  </div>
</div>

<div
  *ngIf="showModal()"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 animate-fade-in"
  (click)="closeModal()"
  style="backdrop-filter: blur(4px);"
>
  <mat-card
    class="max-h-[90vh] w-full max-w-2xl overflow-y-auto rounded-2xl border bg-background shadow-xl animate-scale-in"
    (click)="$event.stopPropagation()"
  >
    <div class="sticky top-0 z-10 flex items-center justify-between border-b bg-background/95 px-6 py-4 backdrop-blur">
      <div>
        <h3 class="text-lg font-semibold text-foreground">Weekly Evaluation</h3>
        <p class="text-sm text-muted-foreground">{{ getFullName(selectedPerson()) }} · {{ personType() === 'employee' ? 'Employee' : 'Trainee' }}</p>
      </div>
      <button mat-icon-button (click)="closeModal()" aria-label="Close">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <form [formGroup]="evaluationForm" (ngSubmit)="submitEvaluation()" class="p-6">
      <!-- 2 Column Layout -->
      <div class="grid gap-6 lg:grid-cols-[1.2fr_1fr]">
        <!-- LEFT COLUMN: Criteria & Test Score -->
        <div class="space-y-6">
          <!-- Evaluation Criteria Section -->
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <h4 class="text-sm font-semibold text-foreground uppercase tracking-wide flex items-center gap-2">
                <mat-icon class="text-primary text-lg">stars</mat-icon>
                Evaluation Criteria
              </h4>
              <button 
                mat-stroked-button 
                color="primary"
                type="button"
                (click)="addCriterion()"
                class="!text-xs"
              >
                <mat-icon class="!text-base">add</mat-icon>
                Add Criterion
              </button>
            </div>
            
            <div class="space-y-3 bg-gradient-to-br from-primary/5 to-transparent rounded-xl p-5 border-2 border-primary/10">
              <div 
                *ngFor="let criterion of criteria(); trackBy: trackCriterion"
                class="flex items-start gap-3 p-3 bg-white rounded-lg border border-primary/10 shadow-sm"
              >
                <div class="flex-1 space-y-2">
                  <label class="text-sm font-medium text-foreground flex items-center gap-2">
                    <mat-icon class="text-primary text-base">{{ criterion.icon }}</mat-icon>
                    {{ criterion.name }}
                  </label>
                  <app-star-rating 
                    [value]="criterion.rating"
                    (valueChange)="updateCriterionRating(criterion.id, $event)"
                  ></app-star-rating>
                </div>
                <div class="flex gap-1">
                  <button
                    mat-icon-button
                    color="primary"
                    type="button"
                    (click)="editCriterion(criterion.id)"
                    matTooltip="Edit criterion name"
                    class="!mt-1"
                  >
                    <mat-icon class="!text-lg">edit</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    color="warn"
                    type="button"
                    (click)="removeCriterion(criterion.id)"
                    matTooltip="Remove criterion"
                    class="!mt-1"
                  >
                    <mat-icon class="!text-lg">delete</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Test Score (Optional) -->
          <div class="space-y-4">
            <mat-card class="border-2 border-purple-200 bg-gradient-to-br from-purple-50 to-transparent p-4 shadow-sm">
              <label class="flex items-center gap-2 cursor-pointer mb-3">
                <input 
                  type="checkbox" 
                  formControlName="includeTestScore"
                  class="w-4 h-4 cursor-pointer accent-purple-600"
                />
                <span class="text-sm font-medium text-foreground flex items-center gap-2">
                  <mat-icon class="text-purple-600 text-lg">quiz</mat-icon>
                  Include Test Score (Optional)
                </span>
              </label>

              <div *ngIf="evaluationForm.get('includeTestScore')?.value" class="space-y-3 animate-fade-in pl-6">
                <label class="text-sm font-medium text-foreground flex items-center gap-2">
                  <mat-icon class="text-purple-600 text-base">grading</mat-icon>
                  Test Score
                </label>
                <div class="flex items-center gap-2">
                  <input 
                    type="number" 
                    formControlName="testScore" 
                    min="0"
                    placeholder="Score"
                    class="w-28 rounded-lg border-2 border-purple-200 bg-white px-3 py-2 text-sm text-foreground outline-none ring-purple-600/20 transition focus:ring-2 focus:border-purple-600"
                  />
                  <span class="text-sm text-muted-foreground font-medium">out of</span>
                  <input 
                    type="number" 
                    formControlName="testScoreMax" 
                    min="1"
                    placeholder="Total"
                    class="w-28 rounded-lg border-2 border-purple-200 bg-white px-3 py-2 text-sm text-foreground outline-none ring-purple-600/20 transition focus:ring-2 focus:border-purple-600"
                  />
                </div>
                <p class="text-xs text-muted-foreground bg-white/60 p-2 rounded border border-purple-100">
                  <mat-icon class="!text-xs align-middle">info</mat-icon>
                  Enter the score and total items (e.g., 60 out of 100). This will be converted to a 1-5 scale for the average.
                </p>
              </div>
            </mat-card>
          </div>

          <!-- Overall Average -->
          <mat-card class="border-2 border-primary/20 bg-gradient-to-br from-primary/10 via-primary/5 to-transparent p-5 shadow-md">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-2">
                <mat-icon class="text-primary text-xl">analytics</mat-icon>
                <span class="text-sm font-semibold text-foreground uppercase tracking-wide">Overall Average</span>
              </div>
              <div class="text-right">
                <div class="text-3xl font-bold text-primary">{{ getAverageRating().toFixed(1) }}</div>
                <div class="text-xs text-muted-foreground">out of 5</div>
              </div>
            </div>
            <mat-progress-bar
              mode="determinate"
              color="primary"
              class="!h-3 rounded-full bg-primary/10 shadow-inner"
              [value]="(getAverageRating() / 5) * 100"
            ></mat-progress-bar>
            <div class="mt-3 flex items-center justify-between text-xs text-muted-foreground">
              <span>{{ ((getAverageRating() / 5) * 100).toFixed(0) }}% Rating</span>
              <span class="bg-primary/10 text-primary px-2 py-1 rounded font-medium">
                {{ criteria().length + (evaluationForm.get('includeTestScore')?.value ? 1 : 0) }} criteria evaluated
              </span>
            </div>
          </mat-card>
        </div>

        <!-- RIGHT COLUMN: Detailed Feedback -->
        <div class="space-y-4">
          <h4 class="text-sm font-semibold text-foreground uppercase tracking-wide flex items-center gap-2">
            <mat-icon class="text-green-600 text-lg">chat</mat-icon>
            Detailed Feedback
          </h4>

          <div class="space-y-2">
            <label class="text-sm font-medium text-foreground flex items-center gap-2">
              <mat-icon class="text-green-600 text-base">comment</mat-icon>
              Comments <span class="text-red-600">*</span>
            </label>
            <textarea
              formControlName="comments"
              rows="6"
              placeholder="Provide overall feedback on this week's performance..."
              class="w-full rounded-lg border-2 border-input bg-background px-4 py-3 text-sm text-foreground outline-none ring-green-600/20 transition focus:ring-2 focus:border-green-600 shadow-sm"
            ></textarea>
            <p *ngIf="evaluationForm.get('comments')?.invalid && evaluationForm.get('comments')?.touched" class="text-xs text-red-600 flex items-center gap-1">
              <mat-icon class="!text-sm">error</mat-icon>
              Comments are required
            </p>
          </div>

          <div class="space-y-2">
            <label class="text-sm font-medium text-foreground flex items-center gap-2">
              <mat-icon class="text-green-600 text-base">thumb_up</mat-icon>
              Strengths
            </label>
            <textarea
              formControlName="strengths"
              rows="5"
              placeholder="What did they do particularly well this week?"
              class="w-full rounded-lg border-2 border-input bg-background px-4 py-3 text-sm text-foreground outline-none ring-green-600/20 transition focus:ring-2 focus:border-green-600 shadow-sm"
            ></textarea>
          </div>

          <div class="space-y-2">
            <label class="text-sm font-medium text-foreground flex items-center gap-2">
              <mat-icon class="text-orange-600 text-base">trending_up</mat-icon>
              Areas for Improvement
            </label>
            <textarea
              formControlName="improvements"
              rows="5"
              placeholder="Where can we help them grow faster?"
              class="w-full rounded-lg border-2 border-input bg-background px-4 py-3 text-sm text-foreground outline-none ring-orange-600/20 transition focus:ring-2 focus:border-orange-600 shadow-sm"
            ></textarea>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex flex-col gap-3 sm:flex-row pt-6 border-t-2 mt-6">
        <button
          mat-flat-button
          color="primary"
          type="submit"
          class="flex-1 !py-6 !text-base !font-semibold shadow-lg hover:shadow-xl transition-shadow"
          [disabled]="evaluationForm.invalid"
        >
          <mat-icon class="mr-2">send</mat-icon>
          Submit Evaluation
        </button>
        <button 
          mat-stroked-button 
          type="button" 
          (click)="closeModal()"
          class="!py-6 !text-base"
        >
          <mat-icon class="mr-2">close</mat-icon>
          Cancel
        </button>
      </div>
    </form>
  </mat-card>
</div>
